# NecroBloom - Gothic Plant Tracker

## Project Overview
NecroBloom is a serverless plant-tracking application featuring a whimsically gothic "PixelGrim" aesthetic. It allows users to identify plants, generate care plans, and monitor health using AI.

## Architecture
- **Frontend**: React + Vite SPA.
- **Backend**: Azure Functions (Kotlin/Java 21).
- **Identity**: Microsoft Entra ID (via `@finnminn/auth`). **MANDATORY:** Consult [docs/guides/AUTH_DEBUGGING_AND_IMPLEMENTATION.md](../../docs/guides/AUTH_DEBUGGING_AND_IMPLEMENTATION.md) for all auth logic.
- **Design System**: PixelGrim (via `@finnminn/ui`). **MANDATORY:** Use `<Typography />` components for all text to maintain accessibility standards.
- **AI**: Gemini 2.5 Flash.

## Deployed Infrastructure (Resource Group: `necrobloom-rg`)
| Resource Name | Type | Location | Details |
| :--- | :--- | :--- | :--- |
| **necrobloom-api** | Function App | `canadacentral` | Windows, Consumption Plan (Y1), System Assigned Identity. |
| **necrobloom-api** | App Insights | `canadacentral` | Telemetry and logging. |
| **ASP-necrobloomrg-8596** | App Service Plan | `canadacentral` | Dynamic (Serverless). |
| **necrobloomstorage** | Storage Account | `eastus` | Standard_LRS. Primary vessel for images (`vessel-images`). |
| **necrobloomrg9f4f** | Storage Account | `canadacentral` | Internal storage for Function App. |
| **necrobloom-cosmos** | Cosmos DB Account | `westus2` | NoSQL (Core) API, Serverless mode. |
| **necrobloom-web** | Static Web App | `eastus2` | Free Tier. |

## Database & Storage
- **Database**: `NecroBloomDB`
- **Container**: `Plants` (Partition Key: `/userId`)
- **Blob Container**: `vessel-images` (for plant photos)

## Core Features
- **Plant Identification**: AI-powered recognition from photos.
- **Gothic Care Plans**: Automated care instructions with a whimsically dark tone.
- **Health Monitoring**: Real-time health assessment and diagnostic "oracles".
- **Plant Vessel**: A digital garden for tracking plant lifecycle and history.

## Local Development Tips

- **Auth Mocking**: The Vite proxy injects a mock `x-ms-client-principal` header. Ensure you use `http://localhost:5173`.

- **Cosmos Connectivity**: 
    - Ensure `local.settings.json` exists in `apps/necrobloom/api/` (autogenerated from `.example.json` on run).
    - If you see `SSLHandshakeException` or `Client initialization failed`, you must import the Cosmos Emulator SSL certificate into your JVM's `cacerts`. See `docs/guides/local/INSTALLATION.md`.
    - `CosmosRepository.kt` uses `.gatewayMode()` for better emulator compatibility.

- **Backend Logs**: Check `apps/necrobloom/api/backend.log` or run `./gradlew azureFunctionsRun` directly to see stack traces.

### Build
- **Frontend**: `npx turbo run build --filter=necrobloom`
- **Backend**: `cd apps/necrobloom/api && ./gradlew build azureFunctionsPackage`

## Infrastructure & Troubleshooting Cheatsheet
- **Log Analytics Workspace ID:** `fa552c33-26d4-4494-a42e-1a293c64f7ed`
- **APIM Gateway:** `necrobloom-gateway` (`api.necrobloom.finnminn.com`)
    - **Note:** All `/api/*` routes are proxied via APIM. If a route works locally but returns 404 in production, verify the operation exists in APIM.
- **Common Log Queries (KQL):**
    - **All Backend Traces:** `AppTraces | order by TimeGenerated desc`
    - **API Requests:** `AppRequests | order by TimeGenerated desc`
    - **Filter by Plant ID:** `AppTraces | where Message contains "id-here"`
- **Backend URL:** `https://necrobloom-api-bacdfbezawe3dwce.canadacentral-01.azurewebsites.net`

## CI/CD
The application uses split deployment pipelines:
- **Frontend**: Managed by `.github/workflows/azure-static-web-apps-zealous-tree-08c25ec0f.yml`.
- **Backend**: Managed by `.github/workflows/deploy-necrobloom-backend.yml`.

### Troubleshooting & Fixes
- **Backend Deployment (401 Unauthorized)**:
    - **Issue**: GitHub Action failed with `Unauthorized (CODE: 401)` when fetching Kudu App Settings via publish profile.
    - **Fix 1**: Corrected a typo in the secret name in `.github/workflows/deploy-necrobloom-backend.yml` (`AZURE_NECOBLOOM_...` to `AZURE_NECROBLOOM_...`).
    - **Fix 2**: Enabled SCM Basic Auth on the Function App (Azure defaults this to disabled).
    - **Fix 3**: (Action Required) Ensure the GitHub secret `AZURE_NECROBLOOM_API_PUBLISH_PROFILE` contains a **freshly downloaded** publish profile from the Azure Portal.
    - **Command to enable SCM Auth**: `az resource update --ids /subscriptions/892ba278-02fb-4119-90b3-83778aacc71f/resourceGroups/necrobloom-rg/providers/Microsoft.Web/sites/necrobloom-api/basicPublishingCredentialsPolicies/scm --set properties.allow=true`
    - **Note**: `necrobloom-api` is running on **Windows**, unlike `pip-tracker` which is on Linux. Ensure build artifacts are compatible.
